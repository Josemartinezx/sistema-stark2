<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribuidora Stark - Gestión</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .vencida { background-color: #fef2f2; border-left: 4px solid #ef4444; }
        .loading-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="min-h-screen text-slate-900">

    <div id="app" class="max-w-5xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 text-white w-12 h-12 rounded-xl flex items-center justify-center shadow-lg font-black text-xl">S</div>
                <div>
                    <h1 class="text-2xl font-black text-slate-800">Distribuidora Stark</h1>
                    <div id="authStatus" class="text-[10px] font-bold uppercase tracking-widest text-slate-400">Iniciando sistema...</div>
                </div>
            </div>
            
            <div class="flex items-center gap-2 bg-white p-1.5 rounded-xl border border-slate-200 shadow-sm">
                <span class="text-[10px] font-black text-slate-400 px-2 uppercase">Sede:</span>
                <select id="sedeSelect" class="bg-slate-100 text-slate-800 px-4 py-2 rounded-lg font-bold outline-none cursor-pointer text-sm">
                    <option value="Caracas">Caracas</option>
                    <option value="Maracay">Maracay</option>
                </select>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Stock Actual</p>
                <h3 id="statTotalStock" class="text-3xl font-black text-slate-800">0</h3>
            </div>
            <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Cuentas Pendientes</p>
                <h3 id="statFacturas" class="text-3xl font-black text-orange-500">0</h3>
            </div>
            <div class="bg-blue-600 p-6 rounded-2xl shadow-lg text-white">
                <p class="text-[10px] font-black text-blue-200 uppercase mb-1">Recaudación</p>
                <h3 id="statDinero" class="text-3xl font-black">$ 0.00</h3>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Inventario -->
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="px-6 py-4 border-b bg-slate-50 flex justify-between items-center">
                        <h2 class="font-black text-xs text-slate-500 uppercase tracking-widest">Inventario en <span id="labelSede" class="text-blue-600">Caracas</span></h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50/50 text-[10px] font-bold uppercase text-slate-400">
                                <tr>
                                    <th class="px-6 py-3">Producto</th>
                                    <th class="px-6 py-3">Cantidad</th>
                                    <th class="px-6 py-3">Estatus</th>
                                </tr>
                            </thead>
                            <tbody id="listaStock" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Facturas -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="px-6 py-4 border-b bg-slate-50">
                        <h2 class="font-black text-xs text-slate-500 uppercase tracking-widest">Cuentas por Cobrar</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50/50 text-[10px] font-bold uppercase text-slate-400">
                                <tr>
                                    <th class="px-6 py-3">Cliente</th>
                                    <th class="px-6 py-3">Vence</th>
                                    <th class="px-6 py-3 text-right">Monto</th>
                                    <th class="px-6 py-3"></th>
                                </tr>
                            </thead>
                            <tbody id="listaFacturas" class="divide-y divide-slate-100 text-xs font-medium"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Acciones -->
            <div class="space-y-6">
                <!-- Stock Form -->
                <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                    <h2 class="font-black text-slate-800 mb-4 text-sm uppercase">Actualizar Stock</h2>
                    <div class="space-y-3">
                        <select id="prodInput" class="w-full p-3 bg-slate-50 border rounded-xl font-bold text-sm outline-none">
                            <option value="Heineken">Cerveza Heineken</option>
                            <option value="Budweiser">Cerveza Budweiser</option>
                            <option value="Smirnoff">Smirnoff</option>
                            <option value="Gatorade">Gatorade</option>
                        </select>
                        <input type="number" id="cantInput" placeholder="Cantidad" class="w-full p-3 bg-slate-50 border rounded-xl font-black text-xl text-blue-600 outline-none">
                        <div class="grid grid-cols-2 gap-2">
                            <button id="btnAdd" class="bg-emerald-500 text-white py-3 rounded-xl font-black text-xs hover:bg-emerald-600">ENTRADA</button>
                            <button id="btnRem" class="bg-rose-500 text-white py-3 rounded-xl font-black text-xs hover:bg-rose-600">SALIDA</button>
                        </div>
                    </div>
                </div>

                <!-- Factura Form -->
                <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                    <h2 class="font-black text-slate-800 mb-4 text-sm uppercase">Nueva Factura</h2>
                    <div class="space-y-3">
                        <input type="text" id="fClient" placeholder="Nombre Cliente" class="w-full p-3 bg-slate-50 border rounded-xl text-sm outline-none">
                        <input type="date" id="fDate" class="w-full p-3 bg-slate-50 border rounded-xl text-sm font-bold outline-none">
                        <input type="number" id="fAmount" placeholder="Monto Total $" class="w-full p-3 bg-slate-50 border rounded-xl font-black text-xl text-orange-600 outline-none">
                        <button id="btnSaveFact" class="w-full bg-slate-800 text-white py-3 rounded-xl font-black text-xs hover:bg-slate-900 uppercase">Registrar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Cobro -->
    <div id="modalPay" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl">
            <h3 class="text-xl font-black mb-4 text-slate-800">Procesar Cobro</h3>
            <div id="payDisplay" class="text-3xl font-black text-center text-blue-600 mb-6">$ 0.00</div>
            <select id="payMethod" class="w-full p-4 bg-slate-50 border rounded-xl mb-6 font-bold text-sm">
                <option value="Efectivo">Efectivo</option>
                <option value="Pago Móvil">Pago Móvil</option>
                <option value="Zelle">Zelle</option>
                <option value="Transferencia">Transferencia</option>
                <option value="USDT">USDT</option>
            </select>
            <div class="flex gap-2">
                <button id="confirmPay" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-black text-sm">CONFIRMAR</button>
                <button onclick="document.getElementById('modalPay').classList.add('hidden')" class="px-4 py-3 bg-slate-100 text-slate-500 rounded-xl font-bold text-sm">X</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-xl shadow-xl opacity-0 transition-opacity duration-300 font-bold text-xs uppercase z-[100]"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURACIÓN (RULE 1 & 2)
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'stark-dist';

        // RUTA SIMPLIFICADA PARA GITHUB PAGES (RULE 1)
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'inventory_v1', 'master');

        let localData = null;
        let activeSede = "Caracas";
        let currentFacturaId = null;

        const setStatus = (msg, loading = false) => {
            const el = document.getElementById('authStatus');
            el.innerText = msg;
            el.className = `text-[10px] font-bold uppercase tracking-widest ${loading ? 'text-blue-500 loading-pulse' : 'text-slate-400'}`;
        };

        const notify = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 3000);
        };

        const render = () => {
            if (!localData) return;

            // Render Stock
            const stockBody = document.getElementById('listaStock');
            stockBody.innerHTML = '';
            let totalStockSede = 0;
            const inventory = localData[activeSede] || {};
            
            Object.entries(inventory).forEach(([name, qty]) => {
                totalStockSede += qty;
                stockBody.innerHTML += `
                    <tr>
                        <td class="px-6 py-4 font-bold text-slate-700 text-sm">${name}</td>
                        <td class="px-6 py-4 font-black text-lg">${qty}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded-md text-[9px] font-black uppercase ${qty < 10 ? 'bg-red-100 text-red-600' : 'bg-emerald-100 text-emerald-600'}">
                                ${qty < 10 ? 'Crítico' : 'Bien'}
                            </span>
                        </td>
                    </tr>`;
            });

            // Render Facturas
            const factBody = document.getElementById('listaFacturas');
            factBody.innerHTML = '';
            let pendientes = 0;
            let recaudado = 0;
            const today = new Date().toISOString().split('T')[0];
            const facturas = (localData.facturas && localData.facturas[activeSede]) ? localData.facturas[activeSede] : [];

            facturas.forEach(f => {
                if (f.pago) {
                    recaudado += f.monto;
                } else {
                    pendientes++;
                }

                const esVencida = !f.pago && f.vence < today;

                factBody.innerHTML += `
                    <tr class="${esVencida ? 'vencida' : ''}">
                        <td class="px-6 py-3 font-bold">${f.cliente}</td>
                        <td class="px-6 py-3 font-bold ${esVencida ? 'text-red-600' : 'text-slate-400'}">${f.vence}</td>
                        <td class="px-6 py-3 text-right font-black">$${f.monto.toFixed(2)}</td>
                        <td class="px-6 py-3 text-right">
                            ${f.pago ? 
                                `<span class="text-emerald-500 font-black text-[9px] uppercase border px-2 py-1 rounded bg-emerald-50">${f.metodo}</span>` : 
                                `<button onclick="window.initPay('${f.id}', ${f.monto})" class="bg-blue-600 text-white px-3 py-1 rounded-lg font-black hover:bg-blue-700">COBRAR</button>`
                            }
                        </td>
                    </tr>`;
            });

            document.getElementById('statTotalStock').innerText = totalStockSede;
            document.getElementById('statFacturas').innerText = pendientes;
            document.getElementById('statDinero').innerText = `$ ${recaudado.toLocaleString()}`;
            document.getElementById('labelSede').innerText = activeSede;
        };

        // Actions
        window.updateStock = async (mode) => {
            const prod = document.getElementById('prodInput').value;
            const val = parseInt(document.getElementById('cantInput').value);
            if (!val || val <= 0) return notify("CANTIDAD INVÁLIDA");

            const current = (localData[activeSede] && localData[activeSede][prod]) ? localData[activeSede][prod] : 0;
            const next = mode === '+' ? current + val : current - val;
            if (next < 0) return notify("STOCK INSUFICIENTE");

            try {
                await updateDoc(docRef, { [`${activeSede}.${prod}`]: next });
                document.getElementById('cantInput').value = '';
                notify("SINCRO OK ✅");
            } catch (e) { notify("ERROR DE RED"); }
        };

        window.saveFactura = async () => {
            const client = document.getElementById('fClient').value.trim();
            const date = document.getElementById('fDate').value;
            const amount = parseFloat(document.getElementById('fAmount').value);
            if (!client || !date || !amount) return notify("COMPLETA LOS CAMPOS");

            const newF = { id: Date.now().toString(), cliente: client, vence: date, monto: amount, pago: false };
            const list = (localData.facturas && localData.facturas[activeSede]) ? [...localData.facturas[activeSede], newF] : [newF];

            try {
                await updateDoc(docRef, { [`facturas.${activeSede}`]: list });
                document.getElementById('fClient').value = '';
                document.getElementById('fAmount').value = '';
                notify("FACTURA GUARDADA ✅");
            } catch (e) { notify("FALLO AL GUARDAR"); }
        };

        window.initPay = (id, monto) => {
            currentFacturaId = id;
            document.getElementById('payDisplay').innerText = `$ ${monto.toFixed(2)}`;
            document.getElementById('modalPay').classList.remove('hidden');
        };

        window.confirmPay = async () => {
            const method = document.getElementById('payMethod').value;
            const list = localData.facturas[activeSede].map(f => 
                f.id === currentFacturaId ? {...f, pago: true, metodo: method} : f
            );
            try {
                await updateDoc(docRef, { [`facturas.${activeSede}`]: list });
                document.getElementById('modalPay').classList.add('hidden');
                notify("COBRO REALIZADO");
            } catch (e) { notify("FALLO AL COBRAR"); }
        };

        // Initialize Firebase (RULE 3)
        const init = async () => {
            try {
                setStatus("AUTENTICANDO...", true);
                await setPersistence(auth, browserLocalPersistence);
                
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error(e);
                setStatus("ERROR DE INICIO");
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                setStatus("SINCRO NUBE...", true);
                
                // Verificar existencia y crear si no hay nada (IMPORTANTE PARA GITHUB)
                const snap = await getDoc(docRef);
                if (!snap.exists()) {
                    await setDoc(docRef, {
                        Caracas: { Heineken: 0, Budweiser: 0, Smirnoff: 0, Gatorade: 0 },
                        Maracay: { Heineken: 0, Budweiser: 0, Smirnoff: 0, Gatorade: 0 },
                        facturas: { Caracas: [], Maracay: [] }
                    });
                }

                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        localData = docSnap.data();
                        setStatus("SISTEMA EN LÍNEA ✅");
                        render();
                    }
                }, (err) => {
                    console.error(err);
                    setStatus("FALLO DE CONEXIÓN");
                });
            }
        });

        // Event Listeners
        document.getElementById('sedeSelect').onchange = (e) => { activeSede = e.target.value; render(); };
        document.getElementById('btnAdd').onclick = () => updateStock('+');
        document.getElementById('btnRem').onclick = () => updateStock('-');
        document.getElementById('btnSaveFact').onclick = saveFactura;
        document.getElementById('confirmPay').onclick = confirmPay;

        init();
    </script>
</body>
</html>
